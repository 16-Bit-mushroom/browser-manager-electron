<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="/static/style.css" />
    <title>Browser Manager | Profiles</title>
</head>

<body>
    <div class="main-container">

        <div class="nav-bar">
            <div>
                <h2 class="app-name">Browser Manager</h2>

                <ul class="nav-bar-links">
                    <li><a href="/projects.html"><img class="button-icon" src="/static/projects.svg" alt="">Projects</a>
                    </li>
                    <li><a id="profiles-link" href="/profiles.html"><img class="button-icon" src="/static/profiles.svg"
                                alt="">Profiles</a></li>
                    <li><a href="/browsers.html"><img class="button-icon" src="/static/browsers.svg" alt="">Browser</a>
                    </li>
                    <!-- <li><a href="">üï• History</a></li> -->
                    <li><a href=" /recycle-bin.html"><img class="button-icon" src="/static/bin.svg" alt="">Recycle
                            Bin</a></li>
                </ul>
            </div>

            <div>
                <ul class="nav-bar-links">
                    <!-- <button style="padding: 5px; cursor: pointer;;">‚òÄÔ∏è Light Mode</button> -->
                    <li><a href="/settings.html"><img class="button-icon" src="/static/settings.svg" alt="">Settings</a>
                    </li>
                    <li><a href="#" id="logout-link"><img class="button-icon" src="/static/logout.svg" alt="">Sign
                            Out</a></li>

                </ul>
            </div>

        </div>

        <div class="content-area">

            <h1 class="content-header">Profiles</h1>

            <div class="content-top-bar-actions">
                <div class="right">

                    <a class="button" id="add-profile" href="/new-profile.html">Add Profile</a>

                    <a class="button danger" id="delete-selected" style="display:none;">Delete Selected</a>

                    <!-- <button type="button" class="button">
                        <img class="button-icon" src="static/export-file.svg" alt="upload-file" title="Export Profile">
                    </button>

                    <button type="button" class="button">
                        <img class="button-icon" src="static/import-profile.svg" alt="upload-file"
                            title="Import Profile">
                    </button> -->

                </div>
                <!-- <input id="search-bar" type="text" placeholder="Search..."> -->

                <div class="left">

                    <button type="button" class="button" id="sort-btn">Sort by Time</button>

                </div>
            </div>


            <div class="table-wrapper">
                <table class="content-table">
                    <thead>
                        <tr>
                            <th id="far-left-th"><input type="checkbox" name="select" id="" title="Select All"></th>
                            <th>Profile Name</th>
                            <th>Browser</th>
                            <th>Last Used</th>
                            <th id="far-right-th">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="projects-table-body">
                    </tbody>
                </table>
                <div id="message" style="margin-top: 20px; text-align: center; font-weight: bold"></div>
            </div>

        </div>
    </div>

    <script>

        let sortMode = "time"; // default ‚Üí comes sorted by time from backend


        async function loadProfiles() {
            // Changed ID to match your profiles.html
            const tbody = document.getElementById("projects-table-body");
            const messageDiv = document.getElementById("message");

            try {
                const response = await fetch("/api/profiles");
                const profiles = await response.json(); // always fetch fresh

                tbody.innerHTML = ""; // Clear table

                if (profiles.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No profiles found. Create a new one!</td></tr>`;
                    return;
                }

                let sortedProfiles = [...profiles];
                if (sortMode === "name") {
                    sortedProfiles.sort((a, b) => a.name.localeCompare(b.name));
                }

                sortedProfiles.forEach((profile) => {
                    const row = tbody.insertRow();
                    row.dataset.id = profile.id;   // ‚úÖ add profile ID for bulk delete

                    // Column 1: Checkbox
                    const checkboxCell = row.insertCell();
                    checkboxCell.innerHTML = `<input type="checkbox" class="row-checkbox">`;

                    // Column 2: Profile Name
                    row.insertCell().textContent = profile.name;

                    // Column 3: Browser
                    row.insertCell().textContent = profile.browser;

                    // Column 4: Last Used
                    row.insertCell().textContent = profile.last_used_formatted || "Never";

                    // Column 5: Actions (Launch and Delete and Edit buttons)
                    const actionsCell = row.insertCell();

                    const launchButton = document.createElement("button");
                    launchButton.className = "btn-create"; // Assuming .btn-create style is available
                    launchButton.textContent = "Launch";
                    launchButton.title = "Launch";
                    launchButton.dataset.profileId = profile.id;


                    launchButton.style.marginLeft = "8px";
                    launchButton.style.padding = "5px 10px";
                    launchButton.style.border = "none";
                    launchButton.style.marginRight = "5px";
                    launchButton.style.cursor = "pointer";
                    launchButton.style.backgroundColor = "#3F72AF";
                    launchButton.style.color = "#ffffff";
                    launchButton.style.borderRadius = "4px";
                    launchButton.style.fontWeight = "500";



                    launchButton.addEventListener("click", async (event) => {
                        const profileId = event.currentTarget.dataset.profileId; // ‚úÖ FIXED

                        if (!profileId) {
                            console.error("Profile ID not found for launch button.");
                            alert("Error: Could not determine profile to launch.");
                            return;
                        }

                        try {
                            const response = await fetch(
                                `/api/launch_profile/${profileId}`,
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                }
                            );

                            const result = await response.json();

                            if (response.ok) {
                                alert(result.message);
                                setTimeout(() => {
                                    window.location.reload();
                                }, 500); // Reload to update 'Last Used'
                            } else {
                                alert(`Failed to launch profile: ${result.message}`);
                            }
                        } catch (error) {
                            console.error("Error launching profile:", error);
                            alert(`Network or system error: ${error.message}`);
                        }
                    });

                    actionsCell.appendChild(launchButton);

                    const deleteButton = document.createElement("button");
                    deleteButton.className = "btn-delete"; // Assuming .btn-delete style is available
                    deleteButton.title = "Delete";
                    deleteButton.textContent = "Delete";

                    deleteButton.style.marginLeft = "8px";
                    deleteButton.style.padding = "5px 10px";
                    deleteButton.style.border = "none";
                    deleteButton.style.marginRight = "5px";
                    deleteButton.style.cursor = "pointer";
                    deleteButton.style.backgroundColor = "#fd01013b";
                    deleteButton.style.color = "#700303d1";
                    deleteButton.style.borderRadius = "4px";
                    deleteButton.style.fontWeight = "500";


                    deleteButton.addEventListener("click", async () => {
                        const profileId = profile.id;
                        const profileName = profile.name;

                        if (
                            confirm(
                                `Are you sure you want to delete profile: ${profileName}? Profile will be moved to Recycle bin.`
                            )
                        ) {
                            try {
                                const response = await fetch(`/api/profiles/${profileId}`, {
                                    method: "DELETE",
                                });

                                const result = await response.json();

                                if (response.ok) {
                                    // alert(result.message);
                                    loadProfiles(); // Reload profiles to update the table
                                } else {
                                    alert(
                                        `Failed to delete profile: ${result.error || result.message
                                        }`
                                    );
                                }
                            } catch (error) {
                                console.error("Error deleting profile:", error);
                                alert(`Network or system error: ${error.message}`);
                            }
                        }
                    });
                    actionsCell.appendChild(deleteButton);


                    const editButton = document.createElement("button");
                    editButton.className = "edit-delete"; // Assuming .btn-delete style is available
                    // editButton.style.marginLeft = "8px"; // Add some spacing
                    editButton.title = "Edit";

                    editButton.textContent = "Edit";
                    editButton.style.marginLeft = "8px";
                    editButton.style.padding = "5px 10px";
                    editButton.style.border = "none";
                    editButton.style.marginRight = "5px";
                    editButton.style.cursor = "pointer";
                    editButton.style.backgroundColor = "#d7d7d7";
                    editButton.style.color = "#121111b3";
                    editButton.style.color = "#121111b3";
                    editButton.style.fontWeight = "500";
                    editButton.style.borderRadius = "4px";

                    editButton.addEventListener("click", () => {
                        const profileId = profile.id;
                        window.location.href = `/edit-profile.html?id=${profileId}`;
                    });


                    actionsCell.appendChild(editButton);

                });





            } catch (error) {
                if (messageDiv) {
                    messageDiv.textContent = `Error loading profiles: ${error.message}`;
                    messageDiv.style.color = "red";
                }
                console.error("Error loading profiles:", error);
            }
        }

        // Sort button toggle
        document.addEventListener("DOMContentLoaded", () => {
            const sortBtn = document.getElementById("sort-btn");

            if (sortBtn) {
                sortBtn.addEventListener("click", () => {
                    if (sortMode === "time") {
                        sortMode = "name";
                        sortBtn.textContent = "Sort by Recent";
                    } else {
                        sortMode = "time";
                        sortBtn.textContent = "Sort by Name";
                    }
                    loadProfiles();
                });
            }

            loadProfiles();
        });



        // Load profiles when the page is fully loaded
        document.addEventListener("DOMContentLoaded", loadProfiles);

        document.addEventListener("DOMContentLoaded", () => {
            const selectAll = document.querySelector("thead input[type='checkbox']");
            const deleteBtn = document.getElementById("delete-selected");
            const tbody = document.getElementById("projects-table-body");

            function updateDeleteButton() {
                const checkboxes = tbody.querySelectorAll(".row-checkbox");
                const anyChecked = [...checkboxes].some(cb => cb.checked);
                deleteBtn.style.display = anyChecked ? "inline-flex" : "none";
            }

            // Handle Select All
            selectAll.addEventListener("change", () => {
                const checkboxes = tbody.querySelectorAll(".row-checkbox");
                checkboxes.forEach(cb => cb.checked = selectAll.checked);
                updateDeleteButton();
            });

            // Delegate row checkbox changes
            tbody.addEventListener("change", (e) => {
                if (e.target.classList.contains("row-checkbox")) {
                    updateDeleteButton();
                }
            });

            // Bulk delete
            deleteBtn.addEventListener("click", async () => {
                const checkboxes = tbody.querySelectorAll(".row-checkbox:checked");
                const ids = [...checkboxes].map(cb => cb.closest("tr").dataset.id);

                if (!ids.length) return;
                if (!confirm(`Delete ${ids.length} selected profiles? They will be moved to Recycle bin.`)) return;

                try {
                    const res = await fetch("/api/profiles/bulk_delete", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ ids })
                    });
                    const data = await res.json();
                    if (data.status === "success") {
                        loadProfiles(); // reload table
                        selectAll.checked = false;
                        deleteBtn.style.display = "none";
                    } else {
                        alert("Error: " + data.message);
                    }
                } catch (err) {
                    alert("Unexpected error");
                    console.error(err);
                }
            });
        });

    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const logoutLink = document.getElementById("logout-link");
            if (logoutLink) {
                logoutLink.addEventListener("click", function (e) {
                    e.preventDefault(); // stop default navigation

                    if (confirm("Are you sure you want to sign out?")) {
                        window.location.href = "/logout"; // proceed if confirmed
                    }
                });
            }
        });
    </script>



</body>

</html>