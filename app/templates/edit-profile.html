<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="/static/style.css" />
    <title>Browser Manager | Profiles</title>
</head>

<body class="body">
    <div class="main-container">

        <div class="nav-bar">
            <div>
                <h2 class="app-name">Browser Manager</h2>

                <ul class="nav-bar-links">
                    <li><a href="/projects.html"><img class="button-icon" src="/static/projects.svg" alt="">Projects</a>
                    </li>
                    <li><a id="profiles-link" href="/profiles.html"><img class="button-icon" src="/static/profiles.svg"
                                alt="">Profiles</a>
                    </li>

                    <!-- <li><a href="">üï• History</a></li> -->
                    <li><a href=" /recycle-bin.html"><img class="button-icon" src="/static/bin.svg" alt="">Recycle
                            Bin</a></li>
                </ul>
            </div>

            <div>
                <ul class="nav-bar-links">
                    <!-- <button style="padding: 5px; cursor: pointer;;">‚òÄÔ∏è Light Mode</button> -->
                    <li><a href="/settings.html"><img class="button-icon" src="/static/settings.svg" alt="">Settings</a>
                    </li>
                    <li><a href="#" id="logout-link"><img class="button-icon" src="/static/logout.svg" alt="">Sign
                            Out</a></li>

                </ul>
            </div>

        </div>

        <div class="content-area">
            <h1 class="content-header">Edit Profile</h1>

            <div id="message" style="margin-bottom: 10px; text-align: center;"></div>

            <div class="content-card-container">
                <form id="new-profile-form" class="content-card-add-profile">
                    <h3>Profile Details</h3>
                    <label for="browser-type">Choose Browser</label>
                    <select name="browser" id="browser-type" disabled>
                        <option value="chrome" id="browser-chrome">Chrome</option>
                        <option value="firefox" id="browser-firefox">Firefox</option>
                        <option value="brave" id="browser-brave">Brave</option>
                    </select>

                    <label for="profile-name">Profile Name</label>
                    <input type="text" id="profile-name" placeholder="Juan Cruz" required>

                    <label for="notes">Add a Note (optional)</label>
                    <input type="text" id="profile-notes" placeholder="Note">

                    <label for="proxy">Add a Proxy (optional)</label>
                    <input type="text" id="profile-proxy" placeholder="Proxy">

                    <label for="project-id">Choose Project Folder</label>
                    <select name="project" id="project-id">
                        <option value="">No Project</option>
                    </select>

                    <div class="form-actions">
                        <button type="submit" form="new-profile-form" class="button primary-button">Update
                            Profile</button>

                        <a id="cancel-profile" class="button secondary-button" href="/profiles.html"> Cancel</a>
                        <!-- <button type="button" id="cancel-profile" class="button secondary-button">Cancel</button> -->
                    </div>


                </form>

                <!-- <div class="content-card-add-profile">
                    <h3>Options</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="save-cookies" name="save-cookies" checked>
                        <label for="save-cookies">Save Cookies</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="clear-session-on-exit" name="clear-session-on-exit">
                        <label for="clear-session-on-exit">Clear Session on Exit</label>
                    </div> -->


            </div>
        </div>
    </div>
    </div>

    <script>
    // NEW FUNCTION: Fetches and populates the projects dropdown
    async function populateProjectsDropdown(selectedProjectId) {
        const selectElement = document.getElementById("project-id");
        
        // Keep the "No Project" option, but remove any others if they exist
        // Note: The "No Project" option is the first child (index 0)
        while (selectElement.children.length > 1) {
            selectElement.removeChild(selectElement.lastChild);
        }

        try {
            const response = await fetch("/api/projects");
            const projects = await response.json();

            if (!response.ok) {
                console.error("Failed to load projects:", projects.error);
                return;
            }

            projects.forEach((project) => {
                const option = document.createElement("option");
                option.value = project.id;
                option.textContent = project.name;
                
                // Set the 'selected' attribute if this project ID matches the profile's current project_id
                if (project.id == selectedProjectId) {
                    option.selected = true;
                }
                
                selectElement.appendChild(option);
            });

            console.log(`Loaded ${projects.length} projects into dropdown.`);

        } catch (err) {
            console.error("Error fetching projects for dropdown:", err);
        }
    }


    document.addEventListener("DOMContentLoaded", async () => {
        const form = document.getElementById("new-profile-form");
        const profileId = new URLSearchParams(window.location.search).get("id");

        if (!form || !profileId) {
            console.error("Form or profileId missing!");
            return;
        }
        
        // Variable to hold the current project ID to ensure selection after loading
        let currentProjectId = null;

        // --- Fetch current profile data ---
        try {
            const response = await fetch(`/api/profiles/${profileId}`);
            const data = await response.json();

            if (!response.ok) {
                alert("‚ùå Failed to load profile: " + (data.error || "Unknown error"));
                return;
            }

            // Store ID for dropdown population and selection
            currentProjectId = data.project_id;
            
            // Fill input fields with current values
            document.getElementById("profile-name").value = data.name || "";
            document.getElementById("profile-notes").value = data.notes || "";
            document.getElementById("profile-proxy").value = data.proxy || "";
            
            // --- Call the new function to load options and select the current one ---
            await populateProjectsDropdown(currentProjectId);
            // --------------------------------------------------------------------------

            console.log("Loaded profile data:", data);
        } catch (err) {
            console.error("Error loading profile:", err);
            alert("‚ö†Ô∏è Could not load profile data.");
        }

        // --- Handle form submission (update profile) ---
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const payload = {
                name: document.getElementById("profile-name").value.trim(),
                notes: document.getElementById("profile-notes").value.trim(),
                proxy: document.getElementById("profile-proxy").value.trim(),
                // Get the currently selected value from the dynamically loaded select box
                project_id: document.getElementById("project-id").value || null 
            };

            console.log("Sending payload:", payload);

            try {
                const response = await fetch(`/api/edit_profile/${profileId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                console.log("Response from server:", result);

                if (response.ok) {
                    alert("‚úÖ Profile updated successfully!");
                    setTimeout(() => window.location.href = "/profiles.html", 1200);
                } else {
                    alert(`‚ùå ${result.error || "Failed to update profile"}`);
                }

            } catch (err) {
                showToast(`‚ö†Ô∏è Error: ${err.message}`, "orange");
                console.error(err);
            }
        });
    });
</script>



    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const logoutLink = document.getElementById("logout-link");
            if (logoutLink) {
                logoutLink.addEventListener("click", function (e) {
                    e.preventDefault(); // stop default navigation

                    if (confirm("Are you sure you want to sign out?")) {
                        window.location.href = "/logout"; // proceed if confirmed
                    }
                });
            }
        });
    </script>



</body>

</html>